### 项目部署 <a id="deploy"></a>
整体可以采用 Nginx + PM2，Nginx用于提供静态资源(或者load balance)，PM2则作为Node应用的容器。

> 打包前记得配置对应的资源 [publicPath](/#customize)

#### 打包

```shell
npm run prod

## 在根目录的dist文件夹下会生成如下文件夹

├── assets      //生成的静态资源，需要部署到cdn
│   ├── css
│   ├── imgs
│   └── js
└── server      //服务器端文件夹，需要拷贝到服务器，并用pm2启动
    ├── css
    └── imgs
```

#### pm2设置
通过配置文件 `ecosystem.config.js`，可以快速设置pm2的参数，例如服务名称、监听文件改动、添加环境变量、日志文件等。详细配置参考 [pm2官网](https://pm2.keymetrics.io/docs/usage/application-declaration/)。

配置文件示例：
```javascript
module.exports = {
  apps: [{
    name: 'tod-react-ssr',
    script: './app.js',
    source_map_support: true,
    watch: ['*.js'],
    watch_delay: 3000,
    ignore_watch: ['node_modules'],
    env: {
      NODE_ENV: 'production',
      PORT: 8825,
    },
    error_file: '/var/www/logs/tod-react/err.log',
    out_file: '/var/www/logs/tod-react/out.log',
    log_file: '/var/www/logs/tod-react/all.log',
  }],
}
```

### 性能测试 <a id="performance"></a>

性能测试初步从3个维度来考察：
- **空接口**（不做任何操作直接返回）
- **静态html渲染**（不包含任何业务接口请求）
- **只包含1个用户信息接口**


压测环境：
- **本机（2.4 GHz Intel Core i5, 16G内存）**
- **1000并发**
- **test接口环境**


**初步结论**：
- 单纯的服务端渲染目前没有出现明显的性能问题，整体的短板应该还是在业务接口
- 整体上来说，多线程下 + 负载均衡下可以明显提升SSR整体性能，但是会很明显地增加响应时间

#### 单线程情况(fork mode)

```shell
## 空接口
┌─────────┬───────┬───────┬───────┬───────┬──────────┬─────────┬───────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg      │ Stdev   │ Max       │
├─────────┼───────┼───────┼───────┼───────┼──────────┼─────────┼───────────┤
│ Latency │ 29 ms │ 31 ms │ 38 ms │ 57 ms │ 32.37 ms │ 15.9 ms │ 545.73 ms │
└─────────┴───────┴───────┴───────┴───────┴──────────┴─────────┴───────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 20191   │ 20191   │ 31647   │ 31807   │ 30534.4 │ 3451.49 │ 20190   │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 2.46 MB │ 2.46 MB │ 3.86 MB │ 3.88 MB │ 3.73 MB │ 421 kB  │ 2.46 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.

305k requests in 10.17s, 37.3 MB read
13 errors (0 timeouts)


## 静态html渲染
┌─────────┬────────┬────────┬─────────┬─────────┬───────────┬───────────┬────────────┐
│ Stat    │ 2.5%   │ 50%    │ 97.5%   │ 99%     │ Avg       │ Stdev     │ Max        │
├─────────┼────────┼────────┼─────────┼─────────┼───────────┼───────────┼────────────┤
│ Latency │ 385 ms │ 443 ms │ 1103 ms │ 2144 ms │ 490.55 ms │ 303.07 ms │ 3654.76 ms │
└─────────┴────────┴────────┴─────────┴─────────┴───────────┴───────────┴────────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 904     │ 904     │ 2223    │ 2383    │ 2006.91 │ 448.12  │ 904     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 2.86 MB │ 2.86 MB │ 7.04 MB │ 7.55 MB │ 6.36 MB │ 1.42 MB │ 2.86 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.

22k requests in 11.16s, 69.9 MB read
49 errors (0 timeouts)


## 用户信息接口
┌─────────┬────────┬─────────┬─────────┬─────────┬────────────┬───────────┬────────────┐
│ Stat    │ 2.5%   │ 50%     │ 97.5%   │ 99%     │ Avg        │ Stdev     │ Max        │
├─────────┼────────┼─────────┼─────────┼─────────┼────────────┼───────────┼────────────┤
│ Latency │ 964 ms │ 1676 ms │ 2920 ms │ 3118 ms │ 1731.61 ms │ 450.72 ms │ 3975.61 ms │
└─────────┴────────┴─────────┴─────────┴─────────┴────────────┴───────────┴────────────┘
┌───────────┬────────┬────────┬─────────┬───────┬────────┬─────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5% │ Avg    │ Stdev   │ Min    │
├───────────┼────────┼────────┼─────────┼───────┼────────┼─────────┼────────┤
│ Req/Sec   │ 53     │ 53     │ 600     │ 799   │ 539.21 │ 205.24  │ 53     │
├───────────┼────────┼────────┼─────────┼───────┼────────┼─────────┼────────┤
│ Bytes/Sec │ 797 kB │ 797 kB │ 9.02 MB │ 12 MB │ 8.1 MB │ 3.08 MB │ 796 kB │
└───────────┴────────┴────────┴─────────┴───────┴────────┴─────────┴────────┘

Req/Bytes counts sampled once per second.

5k requests in 10.18s, 81 MB read
31 errors (0 timeouts)
```


#### 多线程情况(cluster mode, 2个线程)

```shell
## 空接口
┌─────────┬──────┬───────┬───────┬───────┬──────────┬──────────┬────────────┐
│ Stat    │ 2.5% │ 50%   │ 97.5% │ 99%   │ Avg      │ Stdev    │ Max        │
├─────────┼──────┼───────┼───────┼───────┼──────────┼──────────┼────────────┤
│ Latency │ 6 ms │ 16 ms │ 33 ms │ 36 ms │ 19.34 ms │ 65.87 ms │ 2274.67 ms │
└─────────┴──────┴───────┴───────┴───────┴──────────┴──────────┴────────────┘
┌───────────┬─────────┬─────────┬────────┬─────────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%    │ 97.5%   │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 24063   │ 24063   │ 54079  │ 55327   │ 50928.8 │ 9065.02 │ 24048   │
├───────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 2.93 MB │ 2.93 MB │ 6.6 MB │ 6.75 MB │ 6.21 MB │ 1.11 MB │ 2.93 MB │
└───────────┴─────────┴─────────┴────────┴─────────┴─────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.

509k requests in 10.24s, 62.1 MB read


## 静态html渲染
┌─────────┬───────┬───────┬────────┬────────┬───────────┬───────────┬───────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5%  │ 99%    │ Avg       │ Stdev     │ Max       │
├─────────┼───────┼───────┼────────┼────────┼───────────┼───────────┼───────────┤
│ Latency │ 48 ms │ 70 ms │ 103 ms │ 225 ms │ 109.87 ms │ 493.26 ms │ 9963.8 ms │
└─────────┴───────┴───────┴────────┴────────┴───────────┴───────────┴───────────┘
┌───────────┬─────────┬─────────┬─────────┬───────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5% │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 1594    │ 1594    │ 3691    │ 4089  │ 3418.7  │ 786.97  │ 1594    │
├───────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 5.05 MB │ 5.05 MB │ 11.7 MB │ 13 MB │ 10.8 MB │ 2.49 MB │ 5.05 MB │
└───────────┴─────────┴─────────┴─────────┴───────┴─────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.

34k requests in 10.18s, 108 MB read
605 errors (605 timeouts)


## 用户信息接口
┌─────────┬────────┬─────────┬─────────┬─────────┬────────────┬────────────┬────────────┐
│ Stat    │ 2.5%   │ 50%     │ 97.5%   │ 99%     │ Avg        │ Stdev      │ Max        │
├─────────┼────────┼─────────┼─────────┼─────────┼────────────┼────────────┼────────────┤
│ Latency │ 458 ms │ 1202 ms │ 5182 ms │ 5874 ms │ 1654.83 ms │ 1304.29 ms │ 9581.64 ms │
└─────────┴────────┴─────────┴─────────┴─────────┴────────────┴────────────┴────────────┘
┌───────────┬─────────┬─────────┬────────┬─────────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%    │ 97.5%   │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 181     │ 181     │ 499    │ 739     │ 516.4   │ 178.77  │ 181     │
├───────────┼─────────┼─────────┼────────┼─────────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 2.72 MB │ 2.72 MB │ 7.5 MB │ 11.1 MB │ 7.76 MB │ 2.69 MB │ 2.72 MB │
└───────────┴─────────┴─────────┴────────┴─────────┴─────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.

5k requests in 10.19s, 77.6 MB read
6 errors (6 timeouts)
```
